<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Config - Facility Manager</title>
    <link rel="stylesheet" href="./src/style.css">
</head>

<body>
    <div class="app-layout">
        <aside id="sidebar" class="sidebar"></aside>

        <main class="main-content">
            <header class="top-bar">
                <h2>System Configuration</h2>
                <div class="user-profile">
                    <span id="userName">User Name</span>
                    <div class="avatar" id="userAvatar">U</div>
                    <div class="dropdown-menu">
                        <a href="#" class="dropdown-item">About Us</a>
                        <a href="#" class="dropdown-item" id="logoutBtn">Logout</a>
                    </div>
                </div>
            </header>

            <div class="content-wrapper">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">

                    <!-- Add Building -->
                    <div class="data-table-container" style="padding: 1.5rem;">
                        <h3>Add New Building</h3>
                        <form id="addBuildingForm" style="margin-top: 1rem;">
                            <div class="form-group">
                                <input type="text" id="newBuildingName" placeholder="Building Name" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Building</button>
                        </form>
                    </div>

                    <!-- Add Floor -->
                    <div class="data-table-container" style="padding: 1.5rem;">
                        <h3>Add New Floor</h3>
                        <form id="addFloorForm" style="margin-top: 1rem;">
                            <div class="form-group">
                                <select id="selectBuildingForFloor" required>
                                    <option value="">Select Building</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <input type="text" id="newFloorNumber" placeholder="Floor Number (e.g. 1st, G, 2)"
                                    required>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Floor</button>
                        </form>
                    </div>

                    <!-- Add Office -->
                    <div class="data-table-container" style="padding: 1.5rem;">
                        <h3>Add New Office/Office Number</h3>
                        <form id="addOfficeForm" style="margin-top: 1rem;">
                            <div class="form-group">
                                <select id="selectBuildingForOffice" required>
                                    <option value="">Select Building</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <select id="selectFloorForOffice" required>
                                    <option value="">Select Floor</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <input type="text" id="newOfficeNumber" placeholder="Office Number" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Office</button>
                        </form>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { DB } from './src/db.js';
        import { Auth } from './src/auth.js';
        import './src/main.js';

        // Verify Admin
        const user = Auth.getUser();
        if (user.role !== 'admin') {
            window.location.href = '/dashboard.html';
        }

        const refreshSelects = () => {
            const data = DB.getData();
            const bSelects = [document.getElementById('selectBuildingForFloor'), document.getElementById('selectBuildingForOffice')];

            bSelects.forEach(s => {
                s.innerHTML = '<option value="">Select Building</option>';
                data.buildings.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b.id;
                    opt.textContent = b.name;
                    s.appendChild(opt);
                });
            });
        };

        document.getElementById('selectBuildingForOffice').addEventListener('change', (e) => {
            const bId = parseInt(e.target.value);
            const fSelect = document.getElementById('selectFloorForOffice');
            fSelect.innerHTML = '<option value="">Select Floor</option>';
            if (bId) {
                const data = DB.getData();
                const floors = data.floors.filter(f => f.buildingId === bId);
                floors.forEach(f => {
                    const opt = document.createElement('option');
                    opt.value = f.id;
                    opt.textContent = f.number;
                    fSelect.appendChild(opt);
                });
            }
        });

        document.getElementById('addBuildingForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('newBuildingName').value;
            DB.addBuilding(name);
            alert('Building added!');
            document.getElementById('newBuildingName').value = '';
            refreshSelects();
        });

        document.getElementById('addFloorForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const bId = parseInt(document.getElementById('selectBuildingForFloor').value);
            const num = document.getElementById('newFloorNumber').value;
            DB.addFloor(bId, num);
            alert('Floor added!');
            document.getElementById('newFloorNumber').value = '';
        });

        document.getElementById('addOfficeForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const fId = parseInt(document.getElementById('selectFloorForOffice').value);
            const num = document.getElementById('newOfficeNumber').value;
            DB.addOffice(fId, num);
            alert('Office added!');
            document.getElementById('newOfficeNumber').value = '';
        });

        refreshSelects();
    </script>
</body>

</html>