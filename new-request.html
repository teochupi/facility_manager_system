<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Request - Facility Manager</title>
    <link rel="stylesheet" href="./src/style.css">
</head>

<body>
    <div class="app-layout">
        <aside id="sidebar" class="sidebar"></aside>

        <main class="main-content">
            <header class="top-bar">
                <h2 id="pageTitle">Create New Request</h2>
                <div class="user-profile">
                    <span id="userName">User Name</span>
                    <div class="avatar" id="userAvatar">U</div>
                    <div class="dropdown-menu">
                        <a href="admin.html" class="dropdown-item" id="adminLink">Configuration</a>
                        <a href="#" class="dropdown-item" id="aboutUsLink">About Us</a>
                        <a href="#" class="dropdown-item" id="logoutBtn">Logout</a>
                    </div>
                </div>
            </header>

            <div class="content-wrapper">
                <div class="auth-card" style="max-width: 600px; text-align: left; margin: 0 auto;">
                    <form id="requestForm">
                        <div class="form-group">
                            <label for="buildingSelect" id="lblBuilding">Building</label>
                            <select id="buildingSelect" required>
                                <option value="" id="optBuilding">Select Building</option>
                            </select>
                        </div>

                        <div class="form-group" id="floorGroup" style="display:none;">
                            <label for="floorSelect" id="lblFloor">Floor</label>
                            <select id="floorSelect" required>
                                <option value="" id="optFloor">Select Floor</option>
                            </select>
                        </div>

                        <div class="form-group" id="officeGroup" style="display:none;">
                            <label for="officeSelect" id="lblOffice">Office/Area</label>
                            <select id="officeSelect" required>
                                <option value="" id="optOffice">Select Office</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="problemType" id="lblType">Problem Type</label>
                            <select id="problemType" required>
                                <option value="Electrical" id="optElec">Electrical</option>
                                <option value="HVAC" id="optHvac">HVAC</option>
                                <option value="Plumbing" id="optPlum">Plumbing</option>
                                <option value="Furniture" id="optFurn">Furniture</option>
                                <option value="Cleaning" id="optClean">Cleaning</option>
                                <option value="Other" id="optOther">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="description" id="lblDesc">Problem Description</label>
                            <textarea id="description" rows="4" required></textarea>
                        </div>

                        <div class="form-group">
                            <label id="lblAttachments">Attachments</label>
                            <input type="file" id="attachmentInput" style="display: none;">
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button type="button" class="btn btn-secondary" style="background: #eee; color: #333;"
                                    onclick="document.getElementById('attachmentInput').click()"
                                    id="btnChooseFile">Choose File</button>
                                <span id="fileName" style="font-size: 0.9rem; color: var(--text-muted);">No file
                                    chosen</span>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary btn-block" id="btnSubmit">Submit Request</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { DB } from './src/db.js';
        import { Auth } from './src/auth.js';
        import { I18n } from './src/i18n.js';
        import './src/main.js';

        // Apply translations
        document.getElementById('pageTitle').textContent = I18n.t('newRequest');
        document.getElementById('lblBuilding').textContent = I18n.t('building');
        document.getElementById('optBuilding').textContent = I18n.t('selectBuilding');
        document.getElementById('lblFloor').textContent = I18n.t('floor');
        document.getElementById('optFloor').textContent = I18n.t('selectFloor');
        document.getElementById('lblOffice').textContent = I18n.t('office');
        document.getElementById('optOffice').textContent = I18n.t('selectOffice');
        document.getElementById('lblType').textContent = I18n.t('problemType');
        document.getElementById('lblDesc').textContent = I18n.t('description');
        document.getElementById('btnSubmit').textContent = I18n.t('submit');

        document.getElementById('lblAttachments').textContent = I18n.t('attachments');
        document.getElementById('btnChooseFile').textContent = I18n.t('chooseFile');
        document.getElementById('fileName').textContent = I18n.t('noFile');

        document.getElementById('optElec').textContent = I18n.t('electrical');
        document.getElementById('optHvac').textContent = I18n.t('hvac');
        document.getElementById('optPlum').textContent = I18n.t('plumbing');
        document.getElementById('optFurn').textContent = I18n.t('furniture');
        document.getElementById('optClean').textContent = I18n.t('cleaning');
        document.getElementById('optOther').textContent = I18n.t('other');

        const buildingSelect = document.getElementById('buildingSelect');
        const floorGroup = document.getElementById('floorGroup');
        const floorSelect = document.getElementById('floorSelect');
        const officeGroup = document.getElementById('officeGroup');
        const officeSelect = document.getElementById('officeSelect');
        const requestForm = document.getElementById('requestForm');
        const attachmentInput = document.getElementById('attachmentInput');
        const fileNameSpan = document.getElementById('fileName');

        attachmentInput.addEventListener('change', (e) => {
            fileNameSpan.textContent = e.target.files.length > 0 ? e.target.files[0].name : I18n.t('noFile');
        });

        const data = DB.getData();

        data.buildings.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b.id;
            opt.textContent = I18n.t(b.name);
            buildingSelect.appendChild(opt);
        });

        buildingSelect.addEventListener('change', (e) => {
            const bId = parseInt(e.target.value);
            floorSelect.innerHTML = `<option value="">${I18n.t('selectFloor')}</option>`;
            officeGroup.style.display = 'none';

            if (bId) {
                const floors = data.floors.filter(f => f.buildingId === bId);
                floors.forEach(f => {
                    const opt = document.createElement('option');
                    opt.value = f.id;
                    opt.textContent = f.number;
                    floorSelect.appendChild(opt);
                });
                floorGroup.style.display = 'block';
            } else {
                floorGroup.style.display = 'none';
            }
        });

        floorSelect.addEventListener('change', (e) => {
            const fId = parseInt(e.target.value);
            officeSelect.innerHTML = `<option value="">${I18n.t('selectOffice')}</option>`;

            if (fId) {
                const offices = data.offices.filter(o => o.floorId === fId);
                offices.forEach(o => {
                    const opt = document.createElement('option');
                    opt.value = o.id;
                    opt.textContent = o.number;
                    officeSelect.appendChild(opt);
                });
                officeGroup.style.display = 'block';
            } else {
                officeGroup.style.display = 'none';
            }
        });

        requestForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = Auth.getUser();

            let attachmentBase64 = null;
            if (attachmentInput.files.length > 0) {
                attachmentBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(attachmentInput.files[0]);
                });
            }

            const newRequest = {
                userId: user.id,
                building: buildingSelect.options[buildingSelect.selectedIndex].text,
                floor: floorSelect.options[floorSelect.selectedIndex].text,
                office: officeSelect.options[officeSelect.selectedIndex].text,
                problemType: document.getElementById('problemType').value,
                description: document.getElementById('description').value,
                attachments: attachmentBase64 ? [{ name: attachmentInput.files[0].name, data: attachmentBase64 }] : []
            };

            DB.createRequest(newRequest);
            alert(I18n.getLang() === 'bg' ? 'Заявката е изпратена успешно!' : 'Request submitted successfully!');
            window.location.href = 'dashboard.html';
        });
    </script>
</body>

</html>