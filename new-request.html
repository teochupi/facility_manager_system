<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Request - Facility Manager</title>
    <link rel="stylesheet" href="./src/style.css">
</head>

<body>
    <div class="app-layout">
        <aside id="sidebar" class="sidebar"></aside>

        <main class="main-content">
            <header class="top-bar">
                <h2>Create New Request</h2>
                <div class="user-profile">
                    <span id="userName">User Name</span>
                    <div class="avatar" id="userAvatar">U</div>
                    <div class="dropdown-menu">
                        <a href="/admin.html" class="dropdown-item" id="adminLink">Configuration</a>
                        <a href="#" class="dropdown-item">About Us</a>
                        <a href="#" class="dropdown-item" id="logoutBtn">Logout</a>
                    </div>
                </div>
            </header>

            <div class="content-wrapper">
                <div class="auth-card" style="max-width: 600px; text-align: left; margin: 0 auto;">
                    <form id="requestForm">
                        <div class="form-group">
                            <label for="buildingSelect">Building</label>
                            <select id="buildingSelect" required>
                                <option value="">Select Building</option>
                            </select>
                        </div>

                        <div class="form-group" id="floorGroup" style="display:none;">
                            <label for="floorSelect">Floor</label>
                            <select id="floorSelect" required>
                                <option value="">Select Floor</option>
                            </select>
                        </div>

                        <div class="form-group" id="officeGroup" style="display:none;">
                            <label for="officeSelect">Office/Area</label>
                            <select id="officeSelect" required>
                                <option value="">Select Office</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="problemType">Problem Type</label>
                            <select id="problemType" required>
                                <option value="Electrical">Electrical</option>
                                <option value="HVAC">HVAC</option>
                                <option value="Plumbing">Plumbing</option>
                                <option value="Furniture">Furniture</option>
                                <option value="Cleaning">Cleaning</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="description">Problem Description</label>
                            <textarea id="description" rows="4" placeholder="Describe the issue..." required></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary btn-block">Submit Request</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { DB } from './src/db.js';
        import { Auth } from './src/auth.js';
        import './src/main.js';

        const buildingSelect = document.getElementById('buildingSelect');
        const floorGroup = document.getElementById('floorGroup');
        const floorSelect = document.getElementById('floorSelect');
        const officeGroup = document.getElementById('officeGroup');
        const officeSelect = document.getElementById('officeSelect');
        const requestForm = document.getElementById('requestForm');

        const data = DB.getData();

        // Populate buildings
        data.buildings.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b.id;
            opt.textContent = b.name;
            buildingSelect.appendChild(opt);
        });

        buildingSelect.addEventListener('change', (e) => {
            const bId = parseInt(e.target.value);
            floorSelect.innerHTML = '<option value="">Select Floor</option>';
            officeGroup.style.display = 'none';

            if (bId) {
                const floors = data.floors.filter(f => f.buildingId === bId);
                floors.forEach(f => {
                    const opt = document.createElement('option');
                    opt.value = f.id;
                    opt.textContent = f.number;
                    floorSelect.appendChild(opt);
                });
                floorGroup.style.display = 'block';
            } else {
                floorGroup.style.display = 'none';
            }
        });

        floorSelect.addEventListener('change', (e) => {
            const fId = parseInt(e.target.value);
            officeSelect.innerHTML = '<option value="">Select Office</option>';

            if (fId) {
                const offices = data.offices.filter(o => o.floorId === fId);
                offices.forEach(o => {
                    const opt = document.createElement('option');
                    opt.value = o.id;
                    opt.textContent = o.number;
                    officeSelect.appendChild(opt);
                });
                officeGroup.style.display = 'block';
            } else {
                officeGroup.style.display = 'none';
            }
        });

        requestForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const user = Auth.getUser();
            const newRequest = {
                userId: user.id,
                building: buildingSelect.options[buildingSelect.selectedIndex].text,
                floor: floorSelect.options[floorSelect.selectedIndex].text,
                office: officeSelect.options[officeSelect.selectedIndex].text,
                problemType: document.getElementById('problemType').value,
                description: document.getElementById('description').value
            };

            DB.createRequest(newRequest);
            alert('Request submitted successfully!');
            window.location.href = '/dashboard.html';
        });
    </script>
</body>

</html>